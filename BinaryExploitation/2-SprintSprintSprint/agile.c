#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>

#define SLEEPTIME 1
#define MAX_PASSWORD_LENGTH 256

uint8_t is_match(const char *actual, char *provided) {
    // TODO: Implement this function and test it.
    //       Task has been assigned on Jira to
    //       l33t_pr0_c0d3r.

    return 1;
}

int main() {
    setbuf(stdout, NULL);

    char stage[256] = "analysis";
    char fuzzinput[512];
    char name[64];
    char feedback[128];

    strcpy(stage, "analysis"); // Initialize stage to "analysis"

    while (1) {
        if (!strcmp(stage, "analysis")) {
            printf("Conducting requirements analysis...\n");
            sleep(SLEEPTIME);
            strcpy(stage, "design");
        } else if (!strcmp(stage, "design")) {
            printf("|-The client has given us the requirements!\n");
            sleep(SLEEPTIME);
            printf("`-Let's make the design... Quick! We do not have much time left!\n");
            sleep(SLEEPTIME);
            strcpy(stage, "implement");
        } else if (!strcmp(stage, "implement")) {
            printf("  |-Time to code! Time to code!!! write-add-commit-write-add-commit-...\n");
            sleep(SLEEPTIME);
            printf("  `-No time for testing! Agile! Agile!\n");
            sleep(SLEEPTIME);
            strcpy(stage, "deploy");
        } else if (!strcmp(stage, "testing")) {
            printf("    |-Fuzz testing initiating");
            for(uint8_t i = 0; i < 3; i++) {
                sleep(1);
                printf(".");
            }
            printf("\n");

            while(1) {
                printf("    |-Enter your input (Enter EXIT to exit): ");
                scanf("%512s", fuzzinput);
                if (!strcmp(fuzzinput, "EXIT")) {
                    strcpy(stage, "deploy");
                    printf("    `-Fuzz testing completed!\n");
                    break;
                }

                // Allocate memory for the actual flag
                char *actual = malloc(MAX_PASSWORD_LENGTH);
                if (actual == NULL) {
                    perror("Failed to allocate memory");
                    return EXIT_FAILURE;
                }

                // Read the flag from flag.txt
                FILE *file = fopen("flag.txt", "r");
                if (file == NULL) {
                    perror("Failed to open flag.txt");
                    free(actual);
                    return EXIT_FAILURE;
                }

                // Read the flag into the allocated memory
                if (fgets(actual, MAX_PASSWORD_LENGTH, file) == NULL) {
                    perror("Failed to read flag");
                    fclose(file);
                    free(actual);
                    return EXIT_FAILURE;
                }
                // Remove the newline character if present
                actual[strcspn(actual, "\n")] = 0;

                process_input(actual, fuzzinput);

                fclose(file);

                // Free allocated memory
                free(actual);
            }
        } else if (!strcmp(stage, "deploy")) {
            printf("    |-Deployment in progress");
            for(uint8_t i = 0; i < 3; i++) {
                sleep(1);
                printf(".");
            }
            printf("\n");
            printf("    `-Application deployed!\n");
            sleep(SLEEPTIME);
            strcpy(stage, "maintain");
        } else if (!strcmp(stage, "maintain")) {
            printf("      |-Bug reporting time!\n");
            printf("      |-Enter your name/email: ");

            strcpy(stage, "design");
            scanf("%s", name);
            printf("      |-Enter the details of any bugs you found: ");
            scanf("%128s", feedback);
            printf("      `-Thank you for your feedback!: %s\n", feedback);
        } else {
            // Print something for an unknown stage
            printf("Unknown stage: %s\n", stage);
        }
    }
}

void process_input(const char* actual, char* provided) {
    printf("    |-Processing input");
    for(uint8_t i = 0; i < 3; i++) {
        sleep(1);
        printf(".");
    }
    uint8_t result = is_match(actual, provided);
    printf("\n");
    printf("    `-");
    if(is_match)
        printf(strcat(provided,"%s"), " is a valid input!\n");
    else
        printf(strcat(provided,"%s"), " is not a valid input!\n");
}
